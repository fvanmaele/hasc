# Exercise 2 - Matrix Transpose

## Parameter study

We measured the block sizes `24x4`, `48x4`, `96x4`, `Nx4`, `24x8`, `48x8`, `96x8`, `Nx8`, `24x24`, `48x24`, `96x24`, `Nx24` for the block-consecutive version of matrix transposition. 

This resulted in the following values (bandwidth in GB/s):

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>N</th>
      <th>vanilla-consecutive-write</th>
      <th>vanilla-strided-write</th>
      <th>block-consecutive_write-24x4</th>
      <th>block-consecutive_write-48x4</th>
      <th>block-consecutive_write-96x4</th>
      <th>block-consecutive_write-rowx4</th>
      <th>block-consecutive_write-24x8</th>
      <th>block-consecutive_write-48x8</th>
      <th>block-consecutive_write-96x8</th>
      <th>block-consecutive_write-rowx8</th>
      <th>block-consecutive_write-24x24</th>
      <th>block-consecutive_write-48x24</th>
      <th>block-consecutive_write-96x24</th>
      <th>block-consecutive_write-rowx24</th>
      <th>block-strided-writed-4x24</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>24</td>
      <td>45.024200</td>
      <td>48.028700</td>
      <td>44.59970</td>
      <td>44.97850</td>
      <td>44.83510</td>
      <td>44.44820</td>
      <td>46.76310</td>
      <td>46.86940</td>
      <td>44.68910</td>
      <td>45.80720</td>
      <td>39.49460</td>
      <td>44.54840</td>
      <td>49.10640</td>
      <td>51.06950</td>
      <td>43.42980</td>
    </tr>
    <tr>
      <th>1</th>
      <td>48</td>
      <td>37.628700</td>
      <td>42.850100</td>
      <td>31.72010</td>
      <td>39.43400</td>
      <td>37.39600</td>
      <td>39.67110</td>
      <td>33.75740</td>
      <td>34.26310</td>
      <td>34.15450</td>
      <td>36.02140</td>
      <td>40.26020</td>
      <td>42.37350</td>
      <td>43.86650</td>
      <td>43.65390</td>
      <td>38.56650</td>
    </tr>
    <tr>
      <th>2</th>
      <td>96</td>
      <td>32.181300</td>
      <td>29.131900</td>
      <td>20.90810</td>
      <td>38.73620</td>
      <td>36.56220</td>
      <td>34.08770</td>
      <td>23.82030</td>
      <td>24.29400</td>
      <td>26.84460</td>
      <td>29.97320</td>
      <td>31.31220</td>
      <td>34.43770</td>
      <td>36.76210</td>
      <td>36.57170</td>
      <td>28.36530</td>
    </tr>
    <tr>
      <th>3</th>
      <td>192</td>
      <td>15.131500</td>
      <td>8.536510</td>
      <td>14.87920</td>
      <td>26.41270</td>
      <td>27.01910</td>
      <td>24.17750</td>
      <td>17.01230</td>
      <td>17.17160</td>
      <td>24.21660</td>
      <td>22.47080</td>
      <td>24.02540</td>
      <td>24.10930</td>
      <td>28.36480</td>
      <td>28.78230</td>
      <td>21.47950</td>
    </tr>
    <tr>
      <th>4</th>
      <td>384</td>
      <td>10.439400</td>
      <td>5.708390</td>
      <td>23.81840</td>
      <td>20.03280</td>
      <td>19.23630</td>
      <td>18.56360</td>
      <td>28.23960</td>
      <td>27.33090</td>
      <td>27.64250</td>
      <td>25.98180</td>
      <td>29.29050</td>
      <td>29.11330</td>
      <td>30.73490</td>
      <td>29.22350</td>
      <td>22.36570</td>
    </tr>
    <tr>
      <th>5</th>
      <td>768</td>
      <td>1.378530</td>
      <td>1.613560</td>
      <td>9.36306</td>
      <td>7.56957</td>
      <td>9.01228</td>
      <td>5.54990</td>
      <td>11.11300</td>
      <td>8.18006</td>
      <td>10.87660</td>
      <td>10.01060</td>
      <td>8.85761</td>
      <td>9.73597</td>
      <td>10.20090</td>
      <td>10.81860</td>
      <td>11.07850</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1536</td>
      <td>1.200830</td>
      <td>1.314290</td>
      <td>5.53599</td>
      <td>5.73386</td>
      <td>5.45994</td>
      <td>4.36270</td>
      <td>5.85480</td>
      <td>5.43999</td>
      <td>6.23770</td>
      <td>6.16618</td>
      <td>6.10657</td>
      <td>5.99013</td>
      <td>6.36092</td>
      <td>7.08648</td>
      <td>6.63082</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3072</td>
      <td>0.823136</td>
      <td>1.023640</td>
      <td>4.72552</td>
      <td>4.42060</td>
      <td>4.99538</td>
      <td>3.44289</td>
      <td>5.22739</td>
      <td>5.20166</td>
      <td>5.46630</td>
      <td>5.19036</td>
      <td>4.49714</td>
      <td>5.07850</td>
      <td>5.59260</td>
      <td>6.34389</td>
      <td>5.86332</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6144</td>
      <td>0.646727</td>
      <td>0.788730</td>
      <td>3.60467</td>
      <td>4.37332</td>
      <td>4.31566</td>
      <td>2.85594</td>
      <td>4.54815</td>
      <td>4.65034</td>
      <td>4.92695</td>
      <td>3.44494</td>
      <td>3.87739</td>
      <td>3.55485</td>
      <td>4.88945</td>
      <td>4.89810</td>
      <td>4.36538</td>
    </tr>
    <tr>
      <th>9</th>
      <td>12288</td>
      <td>0.521444</td>
      <td>0.645989</td>
      <td>3.71034</td>
      <td>4.35845</td>
      <td>4.33130</td>
      <td>2.30117</td>
      <td>4.12787</td>
      <td>4.29593</td>
      <td>4.34932</td>
      <td>3.69854</td>
      <td>3.07860</td>
      <td>3.93030</td>
      <td>4.38976</td>
      <td>4.98482</td>
      <td>5.04699</td>
    </tr>
    <tr>
      <th>10</th>
      <td>24576</td>
      <td>0.467076</td>
      <td>0.570841</td>
      <td>3.44860</td>
      <td>2.82533</td>
      <td>2.91099</td>
      <td>1.69264</td>
      <td>3.84020</td>
      <td>3.97722</td>
      <td>4.51829</td>
      <td>2.21696</td>
      <td>2.68028</td>
      <td>3.82246</td>
      <td>4.34416</td>
      <td>4.65542</td>
      <td>4.09715</td>
    </tr>
  </tbody>
</table>

As the table indicates, the best performance overall was achieved with a block size of `96x24`.

## Vectorization

Explicit vectorization resulted in a significant increase for in-cache dimensions (up to `192x192`) and a minor decrease otherwise. Combined blocking and vectorization resulted however in highly reduced performance (~0.002Gb/s for higher dimensions) and is thus left out from the table.

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>N</th>
      <th>vanilla-consecutive-write-avx</th>
      <th>vanilla-strided-write-avx</th>
      <th>block-consecutive_write-avx-rowx24</th>
      <th>block-strided-write-avx-4xrow</th>
      <th>block-strided-write-avx-24xrow</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>24</td>
      <td>50.90610</td>
      <td>56.90140</td>
      <td>76.45670</td>
      <td>67.63520</td>
      <td>66.03850</td>
    </tr>
    <tr>
      <th>1</th>
      <td>48</td>
      <td>48.69880</td>
      <td>52.51030</td>
      <td>47.98960</td>
      <td>54.11270</td>
      <td>51.74110</td>
    </tr>
    <tr>
      <th>2</th>
      <td>96</td>
      <td>38.39660</td>
      <td>46.45120</td>
      <td>43.82670</td>
      <td>46.16210</td>
      <td>43.90340</td>
    </tr>
    <tr>
      <th>3</th>
      <td>192</td>
      <td>25.54610</td>
      <td>23.91010</td>
      <td>28.09920</td>
      <td>24.03970</td>
      <td>24.68710</td>
    </tr>
    <tr>
      <th>4</th>
      <td>384</td>
      <td>24.39420</td>
      <td>19.75230</td>
      <td>27.46950</td>
      <td>19.34010</td>
      <td>19.16030</td>
    </tr>
    <tr>
      <th>5</th>
      <td>768</td>
      <td>3.54352</td>
      <td>3.76233</td>
      <td>8.45711</td>
      <td>3.64503</td>
      <td>3.71698</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1536</td>
      <td>3.32076</td>
      <td>3.38442</td>
      <td>5.85090</td>
      <td>3.35682</td>
      <td>3.52434</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3072</td>
      <td>2.70388</td>
      <td>2.82602</td>
      <td>5.58337</td>
      <td>2.79860</td>
      <td>2.77374</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6144</td>
      <td>2.41144</td>
      <td>2.63618</td>
      <td>5.40127</td>
      <td>2.62015</td>
      <td>2.53201</td>
    </tr>
    <tr>
      <th>9</th>
      <td>12288</td>
      <td>2.14402</td>
      <td>2.34189</td>
      <td>4.77817</td>
      <td>2.37075</td>
      <td>2.43249</td>
    </tr>
    <tr>
      <th>10</th>
      <td>24576</td>
      <td>1.64182</td>
      <td>2.04058</td>
      <td>4.07292</td>
      <td>1.97644</td>
      <td>1.93798</td>
    </tr>
  </tbody>
</table>


## Faster non-inplace transposition

The matrix can be stored as follows:

- 1 array for the lower triangle, stored in col-major fashion;
- 1 array for the diagonal;
- 1 array for the upper triangle, stored in row-major fashion.

Transposition is then a swapping of pointers (for the inplace version) or a consecutive copy of arrays (for the non-inplace version). As such, bandwidth increased significantly for out-of-cache dimensions, about 2x higher than the most suitable blocking version.

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>N</th>
      <th>vanilla-consecutive-write</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>24</td>
      <td>43.5064</td>
    </tr>
    <tr>
      <th>1</th>
      <td>48</td>
      <td>24.1122</td>
    </tr>
    <tr>
      <th>2</th>
      <td>96</td>
      <td>22.1401</td>
    </tr>
    <tr>
      <th>3</th>
      <td>192</td>
      <td>18.7380</td>
    </tr>
    <tr>
      <th>4</th>
      <td>384</td>
      <td>17.9508</td>
    </tr>
    <tr>
      <th>5</th>
      <td>768</td>
      <td>15.4182</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1536</td>
      <td>10.4037</td>
    </tr>
    <tr>
      <th>7</th>
      <td>3072</td>
      <td>11.1682</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6144</td>
      <td>10.9182</td>
    </tr>
    <tr>
      <th>9</th>
      <td>12288</td>
      <td>11.2977</td>
    </tr>
    <tr>
      <th>10</th>
      <td>24576</td>
      <td>10.9036</td>
    </tr>
  </tbody>
</table>